/**
 * # Firestore Security Rules
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership model. The core principle is that
 * users have complete control over their own data, and no user can access, view,
 * or modify another user's data. This creates a secure, private environment for
 * each user.
 *
 * ## Data Structure
 * All user-specific data is stored in a single top-level collection: `/users`.
 * Each user's data is contained within a document where the document ID is the
 * user's Firebase Authentication UID (e.g., `/users/{userId}`). This structure
 * makes it simple to write rules that grant access based on path ownership.
 *
 * ## Key Security Decisions
 * - **Strict Ownership**: All operations (read, write, delete) on a user's document
 *   are restricted to the authenticated user who owns that document.
 * - **No User Enumeration**: Listing the entire `/users` collection is explicitly
 *   disallowed. This is a critical security measure to prevent malicious actors
 *   from discovering the UIDs or emails of all users in the system.
 * - **Self-Creation**: A user can create their own user profile document, but only
 *   if the document ID matches their authentication UID.
 * - **Default Deny**: Any path not explicitly matched by a rule is denied access.
 *
 * ## Denormalization for Authorization
 * This model uses the document ID (`userId`) as the primary key for authorization,
 * which is the most performant pattern. The `User` entity also contains an `id` field
 * which is validated on creation to ensure it matches the document's `{userId}` path
 * parameter. This enforces relational integrity between the path and the data itself,
 * preventing mismatches.
 *
 * ## Structural Segregation
 * The data is segregated by owner at the collection level. Each document in the
 * `/users` collection is a root for a specific user's private data, ensuring that
 * security rules are simple, performant, and easy to reason about.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update and delete
     * operations to prevent acting on documents that do not exist.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that the 'id' field within a new user profile document matches
     * the user's auth UID. This enforces consistency between the document path
     * and its internal data at the time of creation.
     */
    function isCreatingOwnProfile(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Validates that the 'id' field of a user profile is not being changed
     * during an update operation. The user ID should be immutable.
     */
    function isNotChangingProfileId() {
      return request.resource.data.id == resource.data.id;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description
     * Governs access to individual user profile documents. Ensures a user can
     * only create, read, update, and delete their own profile.
     *
     * @path
     * `/users/{userId}`
     *
     * @allow
     * A signed-in user (auth.uid: 'user_abc') can `create` their own profile at `/users/user_abc`
     * as long as the document data includes `id: 'user_abc'`.
     * A signed-in user (auth.uid: 'user_abc') can `get` their own document at `/users/user_abc`.
     *
     * @deny
     * A signed-in user (auth.uid: 'user_abc') cannot `get` another user's document at `/users/user_xyz`.
     * An anonymous user cannot `list` the `/users` collection to prevent user enumeration.
     *
     * @principle
     * Enforces strict document ownership and prevents data leakage by disallowing
     * collection-level list operations. Validates relational integrity on create.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && isCreatingOwnProfile(userId);
      allow update: if isExistingOwner(userId) && isNotChangingProfileId();
      allow delete: if isExistingOwner(userId);
    }
  }
}