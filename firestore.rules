/**
 * # Firestore Security Rules
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership model for user data and allows
 * public write access for newsletter subscriptions while protecting the data.
 *
 * ## Data Structure
 * - `/users/{userId}`: Private user data, only accessible by the owner.
 * - `/newsletter_subscribers/{subscriberId}`: Publicly writable for creation, but read/update/delete are denied.
 *
 * ## Key Security Decisions
 * - **Strict Ownership for Users**: All operations on a user's document are restricted
 *   to the authenticated user who owns that document.
 * - **Public Write for Newsletter**: Anyone can write (create) a new document in the
 *   `newsletter_subscribers` collection to subscribe. This is essential for a public-facing feature.
 * - **No Read/Update/Delete on Newsletter**: To protect subscriber privacy, no one
 *   (not even authenticated users) can read, update, or delete newsletter subscriber data
 *   from the client-side. This prevents data leakage.
 * - **No User Enumeration**: Listing the `/users` or `/newsletter_subscribers` collections is
 *   explicitly disallowed to prevent data harvesting.
 * - **Default Deny**: Any path not explicitly matched by a rule is denied access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isCreatingOwnProfile(userId) {
      return request.resource.data.id == userId;
    }

    function isNotChangingProfileId() {
      return request.resource.data.id == resource.data.id;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description
     * Governs access to individual user profile documents. Enforces strict
     * ownership, allowing a user to manage only their own profile.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Prevent user enumeration
      allow create: if isOwner(userId) && isCreatingOwnProfile(userId);
      allow update: if isExistingOwner(userId) && isNotChangingProfileId();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description
     * Governs access to the newsletter subscribers collection. Allows anyone
     * to subscribe, but protects the list from being read or modified by clients.
     *
     * @allow
     * Any user (authenticated or anonymous) can `create` a new document to subscribe.
     * The `email` field must be a string and `subscribedAt` must be a server timestamp.
     *
     * @deny
     * `get`, `list`, `update`, `delete` are all disallowed to protect subscriber privacy.
     */
    match /newsletter_subscribers/{subscriberId} {
      allow get: if false;
      allow list: if false;
      allow update: if false;
      allow delete: if false;
      allow create: if request.resource.data.email is string &&
                       request.resource.data.subscribedAt == request.time;
    }
  }
}
